/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */

plugins {
  id "nebula.ospackage" version "8.0.3"
  id "de.undercouch.download" version "4.0.1"
}
task downloadPrometheusTar(type: Download) {
  src prometheus_download_url
  dest buildDir
  overwrite false
}

task untarArchive(type: Copy){
  dependsOn downloadPrometheusTar
  from tarTree("${buildDir}/prometheus-2.14.0.linux-amd64.tar.gz")
  into buildDir
}

task buildPrometheus(type: Rpm) {
  dependsOn untarArchive
  packageName 'prometheus'
  version '2.14.0'
  release '1'
  arch X86_64
  preInstall file('scripts/preInstall.sh')
  postInstall file('scripts/postInstall.sh')
  os LINUX
  from("${buildDir}/prometheus-2.14.0.linux-amd64") {
    user 'root'
    permissionGroup 'root'
    fileMode 0751
    include 'prometheus'
    include 'promtool'
    include 'tsdb'
    into '/usr/sbin'
  }
  from("${buildDir}/prometheus-2.14.0.linux-amd64/console_libraries") {
    into '/var/prometheus/console_libraries'
    user 'prometheus'
    permissionGroup 'prometheus'
    fileMode 0644
  }
  from("${buildDir}/prometheus-2.14.0.linux-amd64/consoles") {
    into '/var/prometheus/consoles'
    user 'prometheus'
    permissionGroup 'prometheus'
    fileMode 0644
  }
  from("${buildDir}/prometheus-2.14.0.linux-amd64/") {
    exclude 'prometheus'
    exclude 'promtool'
    exclude 'tsdb'
    exclude 'console_libraries'
    exclude 'consoles'
    into '/etc/prometheus'
    user 'prometheus'
    permissionGroup 'prometheus'
    fileMode 0644
  }
  from('etc/systemd/'){
    into '/etc/systemd/system/'
    user 'root'
    permissionGroup 'root'
    fileMode 0644
  }
  from('etc/prometheus/'){
    into '/etc/prometheus/'
    user 'prometheus'
    permissionGroup 'prometheus'
    fileMode 0644
  }

}
